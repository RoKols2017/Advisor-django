{% extends "base.html" %}

{% block title %}–î–µ—Ä–µ–≤–æ –ø–µ—á–∞—Ç–∏{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">üå≤ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—á–∞—Ç–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º</h5>
    <a href="{% url 'index' %}" class="btn btn-light btn-sm">üîô –ù–∞–∑–∞–¥</a>
  </div>
  <div class="card-body">

    <form method="GET" class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">üìÖ –°</label>
        <input type="date" name="start_date" class="form-control" value="{{ start_date }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">üìÖ –ü–æ</label>
        <input type="date" name="end_date" class="form-control" value="{{ end_date }}">
      </div>
      <div class="col-md-3 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary w-100">üîç –§–∏–ª—å—Ç—Ä</button>
        <a href="{% url 'print_tree' %}" class="btn btn-outline-secondary w-100">–°–±—Ä–æ—Å</a>
      </div>
    </form>

    <p>
      <strong>üßÆ –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:</strong> {{ total_pages }}<br>
      {% if start_date or end_date %}
        <small class="text-muted">
          –ü–µ—Ä–∏–æ–¥:
          {% if start_date %}—Å {{ start_date }}{% endif %}
          {% if start_date and end_date %} –ø–æ {% endif %}
          {% if end_date %}{{ end_date }}{% endif %}
        </small>
      {% endif %}
    </p>

    {% if tree %}
    <div class="tree-wrapper">
      <div class="tree">
        <ul>
          {% for dept_name, dept_data in tree.items %}
            <li>
              <div class="toggle tree-line text-primary fw-bold">
                <span>üìÅ {{ dept_data.name_str }}</span>
                <span>{{ dept_data.total_str }} —Å—Ç—Ä.</span>
                <span>{{ dept_data.percent_str }}</span>
              </div>
              <ul style="display: none;">
                {% for printer_name, printer_data in dept_data.printers.items %}
                  <li>
                    <div class="toggle tree-line text-success">
                      <span>üñ®Ô∏è {{ printer_data.name_str }}</span>
                      <span>{{ printer_data.total_str }} —Å—Ç—Ä.</span>
                      <span></span>
                    </div>
                    <ul style="display: none;">
                      {% for user_name, user_data in printer_data.users.items %}
                        <li>
                          <div class="toggle tree-line">
                            <span>üë§ {{ user_data.name_str }}</span>
                            <span>{{ user_data.total_str }} —Å—Ç—Ä.</span>
                            <span>{{ user_data.percent_str }}</span>
                          </div>
                          <ul style="display: none;">
                            {% for entry in user_data.docs %}
                              <li class="ps-3">
                                <div class="tree-line">
                                  üìÑ {{ entry.doc_str }} ‚Äî {{ entry.pages }} —Å—Ç—Ä. ‚Äî {{ entry.timestamp|date:"d.m.Y H:i" }}
                                </div>
                              </li>
                            {% endfor %}
                          </ul>
                        </li>
                      {% endfor %}
                    </ul>
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% else %}
      <div class="alert alert-warning">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –ø–µ—á–∞—Ç–∏.</div>
    {% endif %}

  </div>
</div>

<style>
  .tree-wrapper {
    max-width: 960px;
    margin: 0 auto;
  }
  .tree ul {
    list-style-type: none;
    padding-left: 1rem;
  }
  .tree-line {
    padding: 4px 8px;
    border-bottom: 1px dashed #ddd;
    font-family: monospace;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }
  .tree-line span:nth-child(2) {
    min-width: 90px;
    text-align: right;
    color: green;
  }
  .tree-line span:nth-child(3) {
    min-width: 70px;
    text-align: right;
    color: #0d6efd;
  }
  .toggle {
    cursor: pointer;
    user-select: none;
  }
</style>

<script>
  document.querySelectorAll(".toggle").forEach(el => {
    el.addEventListener("click", () => {
      const next = el.nextElementSibling;
      if (next && next.tagName === "UL") {
        next.style.display = next.style.display === "none" ? "block" : "none";
      }
    });
  });
</script>
{% endblock %}
